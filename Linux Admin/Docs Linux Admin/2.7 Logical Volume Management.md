## Logical Volume Management

- Hầu hết các `lvm` đều hỗ trợ `physical storage grouping`, `logical volume resizing` và `data migration` (di chuyển dữ liệu).
- `Physical storage grouping` là một cách để nhóm nhiều block device (hard disk, CD,...) thành một thiết bị lưu trữ lớn và hợp lý hơn. Để mở rộng `physical group` này, thì các block device (bao gồm cả các partition) có thể được thêm vào sau.
- Kích thước của `lvm volumes` trên `physical group` này không phụ thuộc vào kích thước riêng lẻ của các thành phần. Tổng kích thước của group bị giới hạn.
- Một trong những tính nay hay của `lvm` là logical volume resizing. Ta có thể tăng kích thước của `lvm volume`, đôi khi còn không cần đến bất kỳ downtime nào. Ngoài ra, ta có thể di chuyển dữ liệu ra khỏi hard disk device, tạo bản sao hoặc tạo snapshot.

## Introduction to lvm

### Problems with standard partitions

- Có một vài lỗi khi làm việc với hard disks và standard partition. 
- Xem xét ví dụ phía dưới về một hệ thống với một hard disk device nhỏ, một hard disk device lớn. Disk đầu tiền (/dev/sda) được chia thành 2 phân vùng, disk thứ 2 (/dev/sdb) có 2 phân vùng và một vài không gian trống.

    ![a](https://imgur.com/R8V5liB.png)

- Trong ví dụ trên, hãy xem xét các giải pháp khi ta muốn tăng dung lượng khả dụng cho `/srv/project42`. Giải pháp thường dùng là ta phải bắt buộc unmount file system, sao lưu dữ liệu, xóa và tạo lại phân vùng, sau đó khôi phục dữ liệu vào remount file system.

### Giải pháp với lvm

- Sử dụng `lvm` sẽ tạo một `virtual layer` ở giữa file system đã được mount và hardware devices. Virtual layer này sẽ cho phép người quản trị tăng dung lượng khả dụng của một file system đã được mount để sử dụng. Khi lvm được sử dụng đúng cách, thì nó sẽ không cần phải unmount file system để mở rộng nó.

    ![a](https://imgur.com/pJZ0VaD.png)

### Các thuật ngữ với LVM

#### physical volume (pv)

- Một `physical volume` là bất kỳ block device nào (disk, partition, RAID device hoặc iSCSI device). Tất cả những thiết bị này đều có thể trở thành member của một `volume group`.
- Câu lệnh để quản lý một `physical volume` được bắt đầu bằng `pv`.
    ```
    root@lab-ubuntu2004:~# pv
    pv         pvchange   pvck       pvcreate   pvdisplay  pvmove     pvremove   pvresize   pvs        pvscan
    ```

#### volume group (vg)

- Một `volume group` là một lớp trừu tượng nằm giữa `block device` và `logical volume`.
- Câu lệnh để quản lý một `volume group` sẽ được bắt đầu với `vg`.
    ```
    root@lab-ubuntu2004:~# vg
    vg             vgchange       vgcreate       vgextend       vgmerge        vgremove       vgscan
    vgcfgbackup    vgck           vgdisplay      vgimport       vgmknodes      vgrename       vgsplit
    vgcfgrestore   vgconvert      vgexport       vgimportclone  vgreduce       vgs
    ```

#### logical volume (lv)

- Một `logical volume` được tạo trong một `volume group`. Logical volume chứa một file system có thể được mount. 
- Sử dụng `lv` cũng tương tự như việc sử dụng `partition` và được thực hiện với các câu lệnh giống nhau (mkfs, mount, fsck, df,...).
- Câu lệnh để quản lý các `lv` bắt đầu với `lv`
    ```
    root@lab-ubuntu2004:~# lv
    lv           lvconvert    lvdisplay    lvm          lvmdiskscan  lvmpolld     lvmsar       lvremove     lvresize     lvscan
    lvchange     lvcreate     lvextend     lvmconfig    lvmdump      lvmsadc      lvreduce     lvrename     lvs
    ```

### Ví dụ :

#### Sử dụng LVM

- Ví dụ dưới đây sẽ cho thấy cách để sử dụng một thiết bị với lvm, cách để tạo volume group và cách để tạo và sử dụng một logical volume.
- Đầu tiên là tạo một physical volume để thêm vào volume group với lệnh `pvcreate`. Lệnh này sẻ tạo một disk hoặc một partition sẵn sàng để dùng trong Volume Group :
    ```
    root@lab-ubuntu2004:~# pvcreate /dev/sdb
    Physical volume "/dev/sdb" successfully created.
    ```

- **Lưu ý** : LVM sẽ sử dụng tốt khi dùng device hoàn chỉnh, nhưng các hệ điều hành khác trong cùng một máy tính (hoặc trong cùng SAN) sẽ không nhận ra lvm và sẽ đánh dấu nó là một block device trống. Ta có thể tránh điều này bằng cách tạo một partition bao trùm toàn bộ device đó, sau đó dùng `pvcreate` trên partition vừa tạo thay vì disk.

- Sau đó ta dùng `vgcreate` tạo một volume group sử dụng một thiết bị. Lưu ý rằng nhiều thiết bị có thể được thêm vào volume group.
    ```
    root@lab-ubuntu2004:~# vgcreate vg /dev/sdb
    Volume group "vg" successfully created
    ```

- Bước cuối cùng là sử dụng `lvcreate` để tạo một logical volume.
    ```
    root@lab-ubuntu2004:~# lvcreate --size 500m vg
    Logical volume "lvol0" created.
    ```

- Volume group mới (/dev/vg/lvol0) bây giờ có thể được format với ext4, và mount để sử dụng bình thường.
    ```
    root@lab-ubuntu2004:~# mkfs.ext4 /dev/vg/lvol0
    mke2fs 1.45.5 (07-Jan-2020)
    Creating filesystem with 128000 4k blocks and 128000 inodes
    Filesystem UUID: 010742f4-3401-4022-b9de-ae79ca8a5c98
    Superblock backups stored on blocks:
        32768, 98304

    Allocating group tables: done
    Writing inode tables: done
    Creating journal (4096 blocks): done
    Writing superblocks and filesystem accounting information: done

    root@lab-ubuntu2004:~# mkdir /home/abc0
    root@lab-ubuntu2004:~# mount /dev/vg/lvol0 /home/abc0/
    root@lab-ubuntu2004:~# df -h | grep abc0
    /dev/mapper/vg-lvol0  468M   24K  433M   1% /home/abc0
    ```

- Một logical volume cũng tương tự như một partition, nó có thể được format với một file system và mount để user có thể truy cập nó.

#### Mở rộng một logical volume

- Một logical volume có thể được mở rộng mà không cần phải unmount file system. Việc một volume có thể được mở rộng hay không phụ thuộc vào file system mà nó sử dụng. Những volume được mount với vfat hoặc ext2 không thể được mở rộng, vì vậy ví dụ dưới đâu ta sử dụng file system là ext4.
- Lệnh fdisk sẽ cho ta thấy những scsi-disks mới được thêm vào để phục vụ cho LVM volume. Volume này sau đó sẽ được mở rộng.
    ```
    root@lab-ubuntu2004:~# fdisk -l | grep sd[bc]
    Disk /dev/sdb: 10 GiB, 10737418240 bytes, 20971520 sectors
    Disk /dev/sdc: 1 GiB, 1073741824 bytes, 2097152 sectors
    ```

- 

